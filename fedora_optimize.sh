#!/bin/bash

# ============================================================================
# fedora_optimize.sh - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Fedora
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ fedora_optimize.sh, –∑–∞—Ç–µ–º: chmod +x fedora_optimize.sh && ./fedora_optimize.sh
# ============================================================================

set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

echo "========================================================"
echo "üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Æ FEDORA"
echo "========================================================"

# ============================================================================
# –®–ê–ì 1: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò openh264
# ============================================================================
echo "‚ñ∂ –®–ê–ì 1: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É —Å –ø–∞–∫–µ—Ç–æ–º openh264..."
if ! grep -q "exclude=openh264" /etc/dnf/dnf.conf; then
    echo "# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞" | sudo tee -a /etc/dnf/dnf.conf
    echo "exclude=openh264" | sudo tee -a /etc/dnf/dnf.conf
    echo "‚úÖ openh264 –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è"
else
    echo "‚úÖ openh264 —É–∂–µ –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö"
fi

sleep 1

# ============================================================================
# –®–ê–ì 2: –£–°–¢–ê–ù–û–í–ö–ê RPM FUSION
# ============================================================================
echo ""
echo "‚ñ∂ –®–ê–ì 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ RPM Fusion..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ RPM Fusion —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! rpm -q rpmfusion-free-release > /dev/null 2>&1; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º RPM Fusion Free..."
    sudo dnf install -y https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
    echo "‚úÖ RPM Fusion Free —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚úÖ RPM Fusion Free —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

if ! rpm -q rpmfusion-nonfree-release > /dev/null 2>&1; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º RPM Fusion Non-Free..."
    sudo dnf install -y https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
    echo "‚úÖ RPM Fusion Non-Free —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚úÖ RPM Fusion Non-Free —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

sleep 1

# ============================================================================
# –®–ê–ì 3: –£–°–ö–û–†–ï–ù–ò–ï DNF/DNF5
# ============================================================================
echo ""
echo "‚ñ∂ –®–ê–ì 3: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É—Å–∫–æ—Ä–µ–Ω–∏–µ DNF..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è
if ! grep -q "fastestmirror=True" /etc/dnf/dnf.conf; then
    echo "‚ö° –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤ dnf.conf..."
    sudo tee -a /etc/dnf/dnf.conf > /dev/null << 'EOF'

# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ò –£–°–ö–û–†–ï–ù–ò–Ø DNF (–¥–æ–±–∞–≤–ª–µ–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–º)
# ============================================================================
fastestmirror=True           # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –±—ã—Å—Ç—Ä—ã—Ö –∑–µ—Ä–∫–∞–ª
max_parallel_downloads=10    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ (—É—Å–∫–æ—Ä—è–µ—Ç –≤ 5-10 —Ä–∞–∑)
defaultyes=True             # –û—Ç–≤–µ—Ç "–î–∞" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
keepcache=True              # –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –≤ –∫—ç—à–µ
deltarpm=True               # –ó–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—ç–∫–æ–Ω–æ–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫)
deltarpm_percentage=70      # –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è deltarpm
metadata_expire=1h          # –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
minrate=1                   # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
ip_resolve=4                # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IPv4 (–µ—Å–ª–∏ IPv6 –º–µ–¥–ª–µ–Ω–Ω—ã–π)
timeout=10                  # –¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)
retries=3                   # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
EOF
    echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã"
else
    echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"
fi

sleep 1

# ============================================================================
# –®–ê–ì 4: –£–°–¢–ê–ù–û–í–ö–ê –ü–õ–ê–ì–ò–ù–û–í DNF
# ============================================================================
echo ""
echo "‚ñ∂ –®–ê–ì 4: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–∞–≥–∏–Ω—ã DNF..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–∞–≥–∏–Ω—ã
echo "üîå –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞–≥–∏–Ω fastestmirror..."
if ! dnf list installed "dnf-plugin-fastestmirror" > /dev/null 2>&1; then
    sudo dnf install -y dnf-plugin-fastestmirror
    echo "‚úÖ –ü–ª–∞–≥–∏–Ω fastestmirror —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚úÖ –ü–ª–∞–≥–∏–Ω fastestmirror —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

echo "üîå –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–µ –ø–ª–∞–≥–∏–Ω—ã DNF..."
if ! dnf list installed "dnf-plugins-core" > /dev/null 2>&1; then
    sudo dnf install -y dnf-plugins-core
    echo "‚úÖ –ë–∞–∑–æ–≤—ã–µ –ø–ª–∞–≥–∏–Ω—ã DNF —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚úÖ –ë–∞–∑–æ–≤—ã–µ –ø–ª–∞–≥–∏–Ω—ã DNF —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
fi

sleep 1

# ============================================================================
# –®–ê–ì 5: –£–°–¢–ê–ù–û–í–ö–ê GNOME –£–¢–ò–õ–ò–¢
# ============================================================================
echo ""
echo "‚ñ∂ –®–ê–ì 5: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º GNOME Tweaks –∏ —É—Ç–∏–ª–∏—Ç—ã..."

# –°–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
gnome_packages=(
    "gnome-tweaks"          # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GNOME
    "chrome-gnome-shell"    # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±—Ä–∞—É–∑–µ—Ä–æ–º –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
    "gnome-extensions-app"  # –ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
)

for package in "${gnome_packages[@]}"; do
    echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º $package..."
    if ! dnf list installed "$package" > /dev/null 2>&1; then
        sudo dnf install -y "$package"
        echo "‚úÖ $package —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    else
        echo "‚úÖ $package —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi
done

sleep 1

# ============================================================================
# –®–ê–ì 6: –û–ß–ò–°–¢–ö–ê –ö–≠–®–ê
# ============================================================================
echo ""
echo "‚ñ∂ –®–ê–ì 6: –û—á–∏—â–∞–µ–º –∫—ç—à —Å–∏—Å—Ç–µ–º—ã..."

echo "üßπ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º GNOME Software..."
if pgrep -x "gnome-software" > /dev/null; then
    killall gnome-software 2>/dev/null || true
    echo "‚úÖ GNOME Software –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

echo "üßπ –£–¥–∞–ª—è–µ–º –∫—ç—à GNOME Software..."
rm -rf ~/.cache/gnome-software 2>/dev/null || true
echo "‚úÖ –ö—ç—à GNOME Software –æ—á–∏—â–µ–Ω"

echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à DNF..."
sudo dnf clean all
echo "‚úÖ –ö—ç—à DNF –æ—á–∏—â–µ–Ω"

sleep 1

flatpak install flathub com.mattjakeman.ExtensionManager -y

# ============================================================================
# –ó–ê–í–ï–†–®–ï–ù–ò–ï
# ============================================================================
echo ""
echo "========================================================"
echo "‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "========================================================"
echo ""
echo "üìã –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û:"
echo "   1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ openh264"
echo "   2. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã RPM Fusion —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
echo "   3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ —É—Å–∫–æ—Ä–µ–Ω–∏–µ DNF (10x –±—ã—Å—Ç—Ä–µ–µ!)"
echo "   4. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–ª–∞–≥–∏–Ω—ã DNF"
echo "   5. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã GNOME Tweaks –∏ —É—Ç–∏–ª–∏—Ç—ã"
echo "   6. ‚úÖ –û—á–∏—â–µ–Ω —Å–∏—Å—Ç–µ–º–Ω—ã–π –∫—ç—à"
echo ""
echo "üé® –ß–¢–û –î–ï–õ–ê–¢–¨ –î–ê–õ–¨–®–ï:"
echo ""
echo "1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):"
echo "   flatpak install flathub com.mattjakeman.ExtensionManager"
echo ""
echo "2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–æ–ª–µ–∑–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ Extension Manager:"
echo "   - Vitals (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã)"
echo "   - Dash to Dock (—É–¥–æ–±–Ω–∞—è –ø–∞–Ω–µ–ª—å)"
echo "   - Burn my window (–∫—Ä–∞—Å–∏–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã)"
echo "   - Keep pinned apps in AppGrid (–¢—Ä–µ–π)"
echo ""
echo "3. –û–±–Ω–æ–≤–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É:"
echo "   sudo dnf update -y"
echo ""
echo "4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä:"
echo "   sudo reboot"
echo ""
